<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Home</title>
    <link rel="stylesheet" href="/static/ahome.css" />
    <style>
      /* Your CSS is clean and mostly perfect. No errors found. */
      .overlay {
        background-color: rgba(0, 0, 0, 0.6);
        position: fixed;
        width: 100%;
        height: 100%;
        top: 0;
        left: 0;
        display: none;
        z-index: 998;
      }
      .dashbox {
        position: fixed;
        z-index: 999;
        background-color: #e5dcc3;
        color: black;
        padding: 30px;
        width: 500px;
        border-radius: 8px;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        display: none;
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.4);
      }
      .dashbox h2 {
        margin-top: 0;
        font-size: 20px;
        background: #d8caa5;
        padding: 10px;
      }
      .dashbox form {
        margin-top: 20px;
      }
      .dashbox label {
        display: block;
        margin: 10px 0 4px;
      }
      .logout {
        background-color: #e74c3c;
        color: white;
        padding: 6px 12px;
        border-radius: 5px;
        margin-top: 10px;
        right: 3%;
        position: absolute;
        text-decoration: none;
        font-weight: bold;
        transition: background-color 0.3s ease;
      }

      .logout:hover {
        background-color: #ffff;
        color: #c0392b;
      }
      .dashbox input,
      .dashbox select {
        width: 100%;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 5px;
      }
      .button-row {
        display: flex;
        justify-content: space-between;
        margin-top: 15px;
      }
      .btn-save {
        background-color: #58d68d;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
      }
      .btn-close {
        background-color: #f8c471;
        color: black;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
      }
      .btn-save:hover,
      .btn-close:hover {
        opacity: 0.8;
      }
      .profile {
        position: absolute;
        margin-top: 10px;
        margin-right: 10px;
        padding: 3px;
        border-radius: 100%;
        right: 0%;
        display: inline;
        background-color: white;
      }
      #dashboardSection,
      #voterListSection {
        padding: 20px;
        display: none;
      }
      table {
        width: 100%;
        border-collapse: collapse;
      }
      th,
      td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: left;
        vertical-align: middle;
      }
      th {
        background-color: #f2f2f2;
      }
      td img {
        border-radius: 50%;
        object-fit: cover;
        width: 50px;
        height: 50px;
      }
      .vote-box {
        background-color: #fff;
        border-radius: 8px;
        padding: 20px;
        margin-right: 3%;
        margin-left: 14%;
        margin-bottom: 30px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        position: relative; /* or just remove this line */
      }

      .vote-header {
        border-bottom: 1px solid #ccc;
        padding-bottom: 10px;
        margin-bottom: 15px;
      }

      .vote-header h3 {
        display: inline-block;
        font-size: 22px;
        margin-right: 15px;
      }

      .vote-header p {
        display: inline-block;
        font-weight: bold;
        color: #333;
      }

      .reset-btn {
        float: right;
        background-color: #73d673;
        border: none;
        padding: 5px 10px;
        border-radius: 4px;
        color: #fff;
        font-size: 14px;
        cursor: pointer;
      }

      .candidate-card {
        display: flex;
        align-items: center;
        margin-bottom: 15px;
      }

      .candidate-card input[type="radio"] {
        margin-right: 15px;
        transform: scale(1.3);
      }

      .candidate-info {
        display: flex;
        align-items: center;
      }

      .candidate-img {
        width: 100px;
        height: 100px;
        object-fit: cover;
        border-radius: 4px;
        margin-right: 20px;
      }

      .candidate-name {
        font-size: 20px;
        color: #222;
      }

      .platform-btn {
        background-color: #2c7edb;
        color: #fff;
        border: none;
        padding: 6px 12px;
        margin-top: 5px;
        border-radius: 4px;
        font-size: 14px;
        cursor: pointer;
      }

      .submit-vote {
        background-color: #58d68d;
        color: white;
        font-size: 18px;
        padding: 10px 30px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
      }

      .submit-vote:hover,
      .platform-btn:hover,
      .reset-btn:hover {
        opacity: 0.85;
      }
    </style>
  </head>
  <body>
    <input type="checkbox" id="togglebtn" hidden />

    <label for="togglebtn" class="toggle">
      <span class="top_line common"></span>
      <span class="mid_line common"></span>
      <span class="bottom_line common"></span>
    </label>

    <div class="top">
      <nav>
        <h1>Online Voting System</h1>
        <a href="/logout" class="logout">Logout</a>
        <a href="/profile" class="profile" aria-label="Profile">üë§</a>
      </nav>
    </div>

    <div class="menubar">
      <h1>Menu</h1>
      <nav class="nav1" aria-label="Main menu">
        <ul>
          <h3>üìä Report</h3>
          <li><a href="/electionstatus">üíªElection Status</a></li>
        </ul>
      </nav>
    </div>
    <h2 style="text-align: center; font-size: 36px; margin-top: 20px">
      CIT COUNCIL ELECTION
    </h2>
    <div class="main-content">
    {% if positions %}
    {% for position, info in positions.items() %}
      <form
        class="vote-form"
        method="POST"
        action="/submit-vote"
        data-position="{{ position }}"
        data-start="{{ info.start_time }}"
        data-end="{{ info.end_time }}"
      >
        <input type="hidden" name="position" value="{{ position }}" />
        <div class="vote-box">
          <div class="vote-header">
            <h3>{{ position }}</h3>
            <p>Select only one candidate</p>
            <p
              class="countdown"
              id="countdown_{{ position|replace(' ', '_') }}"
            >
              ‚è≥ Loading...
            </p>
            <button
              type="reset"
              class="reset-btn"
              onclick="resetSelection('{{ position }}')"
            >
              üîÑ Reset
            </button>
          </div>
          {% for candidate in info.candidates %}
          <div class="candidate-card">
            <input
              type="radio"
              id="candidate_{{ candidate.id }}_{{ position }}"
              name="candidate"
              value="{{ candidate.id }}"
              required
            />
            <div class="candidate-info">
              <img
                src="/{{ candidate.symbol }}"
                alt="{{ candidate.name }}"
                class="candidate-img"
              />
              <div>
                <strong class="candidate-name">{{ candidate.name }}</strong
                ><br />
                <span>Party: {{ candidate.party }}</span><br />
              </div>
            </div>
          </div>
          {% endfor %}
          <div style="text-align: center; margin-top: 15px">
            <button type="submit" class="submit-vote">
              üó≥Ô∏è Submit Vote for {{ position }}
            </button>
          </div>
        </div>
      </form>
    {% endfor %}
    {% else %}
    <p style="text-align: center; font-size: 24px; color: gray; margin-top: 50px;">
      üì≠ No elections available now.
    </p>
  {% endif %}
</div>
    </div>
    <div id="dashboardSection" role="region" aria-live="polite"></div>
    <div id="voterListSection" role="region" aria-live="polite"></div>

    <div id="dashboardSection" role="region" aria-live="polite"></div>
    <div id="voterListSection" role="region" aria-live="polite"></div>

    <script>
      function closeForms() {
        document.getElementById("overlay").style.display = "none";
      }

      function resetSelection(positionName) {
        const radios = document.getElementsByName(positionName);
        radios.forEach((r) => (r.checked = false));
      }

      document.querySelectorAll(".vote-form").forEach((form) => {
        form.addEventListener("submit", async function (e) {
          e.preventDefault();
          const formData = new FormData(this);
          try {
            const response = await fetch("/submit-vote", {
              method: "POST",
              body: formData,
            });

            const text = await response.text();

            if (!response.ok) {
              alert("‚ùå Error: " + text);
            } else {
              alert(text);
            }
          } catch (err) {
            alert("‚ùå Network or Server Error: " + err.message);
          }
        });
      });
     if (window.history && window.history.pushState) {
    window.history.pushState(null, "", window.location.href);
    window.onpopstate = function () {
      window.location.href = "/"; 
    };
  }
      function resetSelection(index) {
        const radios = document.getElementsByName(`position_${index}`);
        radios.forEach((r) => (r.checked = false));
      }
      function startCountdown(position, startStr, endStr) {
        const countdownElement = document.getElementById(
          "countdown_" + position.replaceAll(" ", "_")
        );
        const formElement = document.querySelector(
          `form[data-position="${position}"]`
        );

        const startTime = new Date(startStr).getTime();
        const endTime = new Date(endStr).getTime();

        const timer = setInterval(() => {
          const now = new Date().getTime();

          function formatTime(ms) {
            const totalSeconds = Math.floor(ms / 1000);
            const days = Math.floor(totalSeconds / (60 * 60 * 24));
            const hours = Math.floor(
              (totalSeconds % (60 * 60 * 24)) / (60 * 60)
            );
            const minutes = Math.floor((totalSeconds % (60 * 60)) / 60);
            const seconds = totalSeconds % 60;

            return `${days}d ${hours}h ${minutes}m ${seconds}s`;
          }

          const timeLeft = endTime - now;
          countdownElement.innerText = `üó≥Ô∏è Voting open: ${formatTime(
            timeLeft
          )} left`;

          formElement
            .querySelectorAll("input, button")
            .forEach((el) => (el.disabled = false));
          formElement.style.opacity = "1";
        }, 1000);
      }
      // Initialize countdown for each position
      document.querySelectorAll(".vote-form").forEach((form) => {
        const position = form.getAttribute("data-position");
        const start = form.getAttribute("data-start");
        const end = form.getAttribute("data-end");

        if (position && start && end) {
          startCountdown(position, start, end);
        }
      });
    </script>
  </body>
</html>
